<!DOCTYPE html>
<html>
	<head>
		<title>aitvaras</title>
		<script src="processing-1.3.6.min.js"></script>
		<script type="application/javascript">
			function getUrlVars() {
				var vars = {};
				var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
					vars[key] = value;
				});
				return vars;
			}

			var vars = getUrlVars();

			function join() {
				var req = new XMLHttpRequest();
				req.onreadystatechange = function() {
					if(req.readyState == 4 && req.status == 200) {
						console.log("sucess!");
						vars.client_id = req.responseText;
					}
				}
				req.open("GET", vars.server + "/join", true);
				req.send();
			}

			function leave() {
				console.log("leave!");
				var req = new XMLHttpRequest();
				req.open("POST", vars.server + "/leave", true);
				req.send(vars.client_id);
			}

			function move(dir, up) {
				var req = new XMLHttpRequest();
				req.open("POST", vars.server + "/input", true);
				req.send(vars.client_id + ":" + dir + ":" + up);
			}

			join();
			window.onbeforeunload = leave;
		</script>
		<script type="application/processing" data-processing-target="pjs">
		float w = 320;
		float h = 320; 

		void setup() {
			size(w, h);
		}

		PVector btn_size = new PVector(64, 64);
		PVector p_up = new PVector((w - btn_size.x) / 2, 20); 
		PVector p_down = new PVector((w - btn_size.x) / 2, h - 20 - btn_size.y); 
		PVector p_left = new PVector(20, (h - btn_size.y) / 2); 
		PVector p_right = new PVector(w - 20 - btn_size.x, (h - btn_size.y) / 2); 

		int c_up = 255;
		int c_down = 255;
		int c_left = 255;
		int c_right = 255;

		void draw() {
			background(0);

			fill(c_up);
			rect(p_up.x, p_up.y, btn_size.x, btn_size.y);
			fill(c_down);
			rect(p_down.x, p_down.y, btn_size.x, btn_size.y);
			fill(c_left);
			rect(p_left.x, p_left.y, btn_size.x, btn_size.y);
			fill(c_right);
			rect(p_right.x, p_right.y, btn_size.x, btn_size.y);

			if(mousePressed) {
				if(ptInRect(mouseX, mouseY, p_up, btn_size)) {
					if(c_up == 255)
						move("u", "d");
					c_up = 128;
				}
				if(ptInRect(mouseX, mouseY, p_down, btn_size)) {
					if(c_down == 255)
						move("d", "d");
					c_down = 128;
				}
				if(ptInRect(mouseX, mouseY, p_left, btn_size)) {
					if(c_left == 255)
						move("l", "d");
					c_left = 128;
				}
				if(ptInRect(mouseX, mouseY, p_right, btn_size)) {
					if(c_right == 255)
						move("r", "d");
					c_right = 128;
				}
			}
			else {
				if(ptInRect(mouseX, mouseY, p_up, btn_size)) {
					if(c_up == 128)
						move("u", "u");
					c_up = 255;
				}
				if(ptInRect(mouseX, mouseY, p_down, btn_size)) {
					if(c_down == 128)
						move("d", "u");
					c_down = 255;
				}
				if(ptInRect(mouseX, mouseY, p_left, btn_size)) {
					if(c_left == 128)
						move("l", "u");
					c_left = 255;
				}
				if(ptInRect(mouseX, mouseY, p_right, btn_size)) {
					if(c_right == 128)
						move("r", "u");
					c_right = 255;
				}
			}
		}

		bool ptInRect(x, y, pos, size) {
			return (x >= pos.x && y >= pos.y && x <= pos.x + size.x && y <= pos.y + size.y);
		}

		</script>
	</head>
	<body>
		<canvas id="pjs"></canvas>
	</body>
</html>
