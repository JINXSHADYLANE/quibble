<!DOCTYPE html>
<html>
	<head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
        <meta charset="utf-8" />
		<title>aitvaras</title>
		<!--<link rel="stylesheet" href="http://code.jquery.com/mobile/1.0.1/jquery.mobile-1.0.1.min.css" />-->
        <script type="text/javascript" charset="utf-8" src="jquery-1.7.2.js"></script>
        <script src="jquery.mobile-1.0.1.js"></script>
		<link href="style.css" rel="stylesheet" type="text/css" />
		<script type="application/javascript">
			function getUrlVars() {
				var vars = {};
				var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
					vars[key] = value;
				});
				return vars;
			}

			var vars = getUrlVars();

			function join() {
				var req = new XMLHttpRequest();
				req.onreadystatechange = function() {
					if(req.readyState == 4 && req.status == 200) {
						console.log("sucess!");
						vars.client_id = req.responseText;
					}
				}
				req.open("GET", vars.server + "/join", true);
				req.send();
			}

			function leave() {
				console.log("leave!");
				var req = new XMLHttpRequest();
				req.open("POST", vars.server + "/leave", true);
				req.send(vars.client_id);
			}

			var btnState = {};

			function move(dir, up) {
				if(btnState[dir] !== up) {
					btnState[dir] = up;
					var req = new XMLHttpRequest();
					req.open("POST", vars.server + "/input", true);
					req.send(vars.client_id + ":" + dir + ":" + up);
				}
			}

			join();
			window.onbeforeunload = leave;
            
            //colors active/inactive button
            function ColorBtn(canvas_id) {
				var ctx = canvas_id.getContext("2d");
				ctx.fillStyle = "rgba(100,255,255,0.5)";
				ctx.fillRect(0,0,1000,1000);
			}
			function ClearColorBtn(canvas_id) {
				var ctx = canvas_id.getContext("2d");
				ctx.clearRect(0,0,1000,1000);
			}
			//here starts virtual mouse events
			$(function(){
                $(".bup").bind({
                    vmousedown: function() {
                        move("u", "d");
			            ColorBtn(canvas_up);
                    },
                    vmouseup: function() {
                        move("u", "u");
                        ClearColorBtn(canvas_up);
                    }
    			});
                $(".bleft").bind({
                    vmousedown: function() {
                        move("l", "d");
                        ColorBtn(canvas_left);
                    },
                    vmouseup: function() {
                        move("l", "u");
                        ClearColorBtn(canvas_left);
                    }
    			});
                $(".bright").bind({
                    vmousedown: function() {
                        move("r", "d");
                        ColorBtn(canvas_right);
                    },
                    vmouseup: function() {
                        move("r", "u");
                        ClearColorBtn(canvas_right);
                    }
    			});
                $(".bdown").bind({
                    vmousedown: function() {
                        move("d", "d");
                        ColorBtn(canvas_down);
                    },
                    vmouseup: function() {
                        move("d", "u");
                        ClearColorBtn(canvas_down);
                    }
    			});
			});
		</script>
		<script type="text/javascript">
			//defines screen width (x) and height (y)
			function ScreenSize() {
				var w=window,
					d=document,
					e=d.documentElement,
					g=d.getElementsByTagName("body")[0],
					x=w.innerWidth||e.clientWidth||g.clientWidth,
					y=w.innerHeight||e.clientHeight||g.clientHeight;

				//based on the sceen dimensions buttons are set to a proper size
				$(document).ready(function(){
					$(".bup").css("height", y*0.3 );
					$(".bleft").css("height", y*0.3 );
					$(".bright").css("height", y*0.3 );
					$(".bdown").css("height", y*0.3 );
				});
			}
			
			//sets proper button size on page load
			ScreenSize();

			//orientation change refreshes the screen size
			$(window).bind('orientationchange', function(event) { 
				ScreenSize(); 
				//alert('orientation change');
			});

			//hides safari url bar
			addEventListener("load", function() { 
				setTimeout(hideURLbar, 0); }, false);
				function hideURLbar(){ window.scrollTo(0,1);
			}	
		</script>
	</head>
	<body>
		<canvas id="canvas_up" class="bup" ></canvas>
		<canvas id="canvas_left" class="bleft"></canvas>
		<canvas id="canvas_right" class="bright"></canvas>
		<canvas id="canvas_down" class="bdown"></canvas>
</body>
	</body>
</html>
