<!DOCTYPE html>
<html>
	<head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=1" />
        <meta charset="utf-8" />
		<title>aitvaras</title>
		<!--<link rel="stylesheet" href="http://code.jquery.com/mobile/1.0.1/jquery.mobile-1.0.1.min.css" />-->
        <script type="text/javascript" charset="utf-8" src="jquery-1.7.2.js"></script>
        <script src="jquery.mobile-1.0.1.js"></script>
		<script src="hammer.min.js"></script>
		<link href="style.css" rel="stylesheet" type="text/css" />
		<script type="application/javascript">

			function absorbEvent_(event) {
			  var e = event || window.event;
			  e.preventDefault && e.preventDefault();
			  //e.stopPropagation && e.stopPropagation();
			 // e.cancelBubble = true;
			  //e.returnValue = false;
			  return false;
			}
			
			function preventLongPressMenu(node) {
			  node.ontouchstart = absorbEvent_;
			  node.ontouchmove = absorbEvent_;
			  node.ontouchend = absorbEvent_;
			  node.ontouchcancel = absorbEvent_;
			}

			function init() {
			  preventLongPressMenu(document.getElementById('canvas_up'));
			  preventLongPressMenu(document.getElementById('canvas_left'));
			  preventLongPressMenu(document.getElementById('canvas_right'));
			  preventLongPressMenu(document.getElementById('canvas_down'));
			  preventLongPressMenu(document.getElementById('body'));
			}		
		
			function getUrlVars() {
				var vars = {};
				var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
					vars[key] = value;
				});
				return vars;
			}

			var vars = getUrlVars();

			function keep_alive() {
				var req = new XMLHttpRequest();
				req.open("POST", vars.server + "/keep_alive", true);
				req.send(vars.client_id);
			};

			setInterval(keep_alive,vars.keep_alive*1000);
			
			function join() {
				var req = new XMLHttpRequest();
				req.onreadystatechange = function() {
					if(req.readyState == 4 && req.status == 200) {
						console.log("sucess!");
						vars.client_id = req.responseText;
					}
				}
				req.open("GET", vars.server + "/join", true);
				req.send();
			}

			function leave() {
				console.log("leave!");
				var req = new XMLHttpRequest();
				req.open("POST", vars.server + "/leave", true);
				req.send(vars.client_id);
			}

			var btnState = {};

			function move(dir, state) {
				if(btnState[dir] !== state) {
					btnState[dir] = state;
					var req = new XMLHttpRequest();
					req.open("POST", vars.server + "/input", true);
					req.send(vars.client_id + ":" + dir + ":" + state);
				}
			}

			join();
			window.onbeforeunload = leave;
            
            //colors active/inactive button
            function ColorBtn(canvas_id) {
				var ctx = canvas_id.getContext("2d");
				ctx.fillStyle = "rgba(100,255,255,0.5)";
				ctx.fillRect(0,0,1000,1000);
			}
			function ClearColorBtn(canvas_id) {
				var ctx = canvas_id.getContext("2d");
				ctx.clearRect(0,0,1000,1000);
			}
			</script>
		<script type="text/javascript">
			//defines screen width (x) and height (y)
			function ScreenSize() {
				var w=window,
					d=document,
					e=d.documentElement,
					g=d.getElementsByTagName("body")[0],
					x=w.innerWidth||e.clientWidth||g.clientWidth,
					y=w.innerHeight||e.clientHeight||g.clientHeight;

				//based on the sceen dimensions buttons are set to a proper size
				$(document).ready(function(){
					$(".bup").css("height", y*0.3 );
					$(".bleft").css("height", y*0.3 );
					$(".bright").css("height", y*0.3 );
					$(".bdown").css("height", y*0.3 );
				});
			}

			function hideURLbar(){ window.scrollTo(0,1);}	
			
			//sets proper button size on page load
			ScreenSize();

			//orientation change refreshes the screen size
			$(window).bind('orientationchange', function(event) { 
				setTimeout(ScreenSize, 10);
				setTimeout(hideURLbar, 10);
			});
			//hides safari url bar
			addEventListener("load", function() {setTimeout(hideURLbar, 10); }, false);

			
		</script>
	</head>
	<body id="body" onload="init()">
		<canvas id="canvas_up" class="bup" ></canvas>
		<canvas id="canvas_left" class="bleft"></canvas>
		<canvas id="canvas_right" class="bright"></canvas>
		<canvas id="canvas_down" class="bdown"></canvas>
		<script>		
		
			var btn_up = Hammer(document.getElementById('canvas_up'), {});
			var btn_down = Hammer(document.getElementById('canvas_down'), {});			
			var btn_left = Hammer(document.getElementById('canvas_left'), {});
			var btn_right = Hammer(document.getElementById('canvas_right'), {});			

		
			btn_up.on('touch release', function(ev) {
				switch(ev.type) {
					case 'touch':
                        move("u", "d");
			            ColorBtn(canvas_up);	
					break;				
					
					case 'release':
                        move("u", "u");
                        ClearColorBtn(canvas_up);
					break;
				}
			});	
			
		
			btn_down.on('touch release', function(ev) {
				switch(ev.type) {
					case 'touch':
                        move("d", "d");
			            ColorBtn(canvas_down);	
					break;				
					
					case 'release':
                        move("d", "u");
                        ClearColorBtn(canvas_down);
					break;
				}
			});	

			btn_left.on('touch release', function(ev) {
				switch(ev.type) {
					case 'touch':
                        move("l", "d");
			            ColorBtn(canvas_left);	
					break;
					
					case 'release':
                        move("l", "u");
                        ClearColorBtn(canvas_left);
					break;
				}
			});	

			btn_right.on('touch release', function(ev) {
				switch(ev.type) {
					case 'touch':
                        move("r", "d");
			            ColorBtn(canvas_right);	
					break;
					
					case 'release':
                        move("r", "u");
                        ClearColorBtn(canvas_right);
					break;
				}
			});			
		</script>
</body>
	</body>
</html>
